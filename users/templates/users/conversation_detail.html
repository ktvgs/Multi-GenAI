

{% extends 'users/base.html' %}
{% load static %}
{% load conversation_extras %}

{% block title %}Conversation{% endblock %}

{% block background_css %}
<style>
    body {
        background: url("{% static 'users/backgrounds/pexels-ron-lach-9783812.jpg' %}") no-repeat center center fixed;
        background-size: cover;
    }
    #side-chat-input {
        background-color: #000;
        color: #fff;
        border: 1px solid #444;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    
    <!-- Left Panel: Main Conversation -->
    <div class="col-md-8">
      <h4 class="mb-4">
        Conversation: <span class="text-primary">{{ convo.title|default:"(Untitled Conversation)" }}</span>
      </h4>

      <div class="mb-3">
        <a href="{% url 'conversations_dashboard' %}" class="btn btn-secondary btn-sm">← All Conversations</a>
        {% if convo.parent_id %}
          <a href="{% url 'conversation_detail' conv_id=convo.parent_id %}" class="btn btn-outline-secondary btn-sm ms-2">← Parent Conversation</a>
        {% endif %}
      </div>

      <!-- Edit title -->
      <form method="POST" class="mb-3">
        {% csrf_token %}
        <input type="text" name="title" value="{{ convo.title }}" placeholder="Enter conversation title" class="form-control mb-2" autocomplete="off" />
        <button type="submit" class="btn btn-primary btn-sm">Save Title</button>
      </form>

      <hr>

      <!-- Chat messages -->
      <div id="chat-box">
        {% for msg in chat_messages %}
          {% include "users/partials/chat_message.html" with msg=msg %}
        {% endfor %}
      </div>

      <!-- AI message form -->
      <form 
          method="POST"
          hx-post="{% url 'add_chat_message_htmx' conv_id=conv_id %}"
          hx-target="#chat-box"
          hx-swap="afterend"
      >
        {% csrf_token %}
        <div class="form-group">
          <label for="message">Your Message:</label>
          <textarea name="message" id="message" class="form-control" required></textarea>
        </div>

        <div class="form-group mt-2">
          <label for="model">Choose AI Model:</label>
          <select name="model" id="model" class="form-control">
            <option value="gemini">Gemini</option>
            <option value="groq">Groq (LLaMA 2)</option>
          </select>
        </div>

        <button class="btn btn-success mt-3" type="submit">Send</button>
      </form>

    </div>

    <!-- Right Panel: Sharing + Side Chat -->
    <div class="col-md-4">
      <!-- Shared Users -->
      <div class="card mb-4">
        <div class="card-header">Shared With</div>
        <div class="card-body">
          {% if shared_users %}
            <ul class="list-group">
              {% for user in shared_users %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ user.username }}
                  <form method="POST"
                        action="{% url 'revoke_access' conv_id=conv_id user_id=user.id %}"
                        hx-post="{% url 'revoke_access' conv_id=conv_id user_id=user.id %}"
                        hx-swap="none"
                        hx-confirm="Are you sure you want to revoke access for {{ user.username }}?">
                    {% csrf_token %}
                    <button class="btn btn-sm btn-danger">Revoke</button>
                  </form>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No users have access.</p>
          {% endif %}
        </div>
        <div class="card-footer">
          <form method="POST"
                action="{% url 'share_conversation' conv_id=conv_id %}"
                hx-post="{% url 'share_conversation' conv_id=conv_id %}"
                hx-swap="none" class="d-flex">
            {% csrf_token %}
            <input type="text" name="username" class="form-control form-control-sm me-2" placeholder="Username" required>
            <button class="btn btn-sm btn-primary" type="submit">Share</button>
          </form>
        </div>
      </div>

      <!-- Side Chat -->
      <div class="card">
        <div class="card-header">Side Chat</div>
        <div class="card-body" style="max-height: 300px; overflow-y: auto;">
          <div id="side-chat-messages">
            {% for msg in side_chat_messages %}
              {% include "users/partials/side_chat_message.html" with msg=msg %}
            {% endfor %}
          </div>
        </div>
        <div class="card-footer">
          <form hx-post="{% url 'send_side_chat_message_htmx' conv_id=conv_id %}" 
                hx-target="#side-chat-messages" 
                hx-swap="beforeend"
                class="d-flex">
            {% csrf_token %}
            <input type="text" name="message" class="form-control me-2" placeholder="Your message">
            <button class="btn btn-sm btn-success" type="submit">Send</button>
          </form>
        </div>
      </div>

    </div>
  </div>
</div>



{% endblock %}
